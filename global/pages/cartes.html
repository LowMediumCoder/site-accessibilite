<!DOCTYPE html>
<html>
	<head>
		<title>Cartes</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
			crossorigin="anonymous" />
		<link
			rel="stylesheet"
			type="text/css"
			href="../css/style.css" />
	</head>
	<body>
		<div class="container mt-5">
			<h1 class="mb-4">Cartes</h1>
			<div class="row mb-4">
				<div class="col-md-6">
					<input
						type="text"
						class="form-control"
						placeholder="Search..."
						id="searchBar" />
				</div>
				<div class="col-md-4 text-end">
					<div
						class="btn-group"
						role="group"></div>
				</div>
			</div>
			<div
				class="row"
				id="cardGrid"></div>
		</div>
		<script>
			document
				.getElementById("searchBar")
				.addEventListener("input", function () {
					const searchTerm = this.value.toLowerCase();
					const cards = document.querySelectorAll(".card-item");
					const activeCategory = document
						.querySelector(".btn-group .btn.btn-primary")
						?.getAttribute("data-category");

					cards.forEach((card) => {
						const title = card
							.querySelector(".card-title")
							.textContent.toLowerCase();
						const matchesSearch = title.includes(searchTerm);
						const matchesCategory =
							!activeCategory ||
							card.getAttribute("data-category") === activeCategory;

						if (matchesSearch && matchesCategory) {
							card.style.display = "block";
						} else {
							card.style.display = "none";
						}
					});
				});

			function filterCards(category) {
				const searchTerm = document
					.getElementById("searchBar")
					.value.toLowerCase();
				const cards = document.querySelectorAll(".card-item");
				const buttons = document.querySelectorAll(".btn-group .btn");
				const activeButton = document.querySelector(
					`.btn-group .btn.btn-primary[data-category="${category}"]`
				);

				if (activeButton) {
					// If the clicked button is already active, remove the filter
					cards.forEach((card) => {
						const title = card
							.querySelector(".card-title")
							.textContent.toLowerCase();
						if (title.includes(searchTerm)) {
							card.style.display = "block";
						} else {
							card.style.display = "none";
						}
					});
					buttons.forEach((button) => {
						button.classList.remove("btn-primary");
						button.classList.add("btn-secondary");
					});
				} else {
					// Apply the filter
					cards.forEach((card) => {
						const title = card
							.querySelector(".card-title")
							.textContent.toLowerCase();
						const matchesSearch = title.includes(searchTerm);
						const matchesCategory =
							card.getAttribute("data-category") === category;

						if (matchesSearch && matchesCategory) {
							card.style.display = "block";
						} else {
							card.style.display = "none";
						}
					});
					buttons.forEach((button) => {
						if (button.getAttribute("data-category") === category) {
							button.classList.remove("btn-secondary");
							button.classList.add("btn-primary");
						} else {
							button.classList.remove("btn-primary");
							button.classList.add("btn-secondary");
						}
					});
				}
			}

			document.addEventListener("DOMContentLoaded", () => {
				fetch("../data/cartes.json")
					.then((response) => response.json())
					.then((data) => {
						const buttonGroup = document.querySelector(".btn-group");

						// Create a button for each famille using famille.titre
						data.familles.forEach((famille) => {
							const button = document.createElement("button");
							button.className = "btn btn-secondary";
							button.setAttribute("data-category", famille.id);
							button.textContent = famille.titre; // Set text content to famille.titre
							button.onclick = () => filterCards(famille.id);
							buttonGroup.appendChild(button);
						});

						const cardGrid = document.getElementById("cardGrid");
						cardGrid.innerHTML = "";

						data.familles.forEach((famille) => {
							famille.cartes.forEach((carte) => {
								const card = document.createElement("div");
								card.className = "col-md-3 mb-4 card-item";
								card.setAttribute("data-category", famille.id);

								card.innerHTML = `
						<div class="card h-100">
							<img src="../img/cartes/${carte.id}.png" class="card-img-top" alt="${carte.titre}" />
							<div class="card-body">
								<h5 class="card-title">${carte.titre}</h5>
								<h6 class="card-body">"${carte.sousTitre}"</h6>
								<p class="card-text">${carte.description}</p>
							</div>
						</div>
					`;

								cardGrid.appendChild(card);
							});
						});

						// Wait for all cards to be added before adding event listeners
						document
							.querySelectorAll("a, button, input, img, .btn-group .btn")
							.forEach((element) => {
								element.addEventListener("mouseover", () => {
									cursorCircle.style.transform = "scale(2)";
									cursorCircle.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
								});
								element.addEventListener("mouseleave", () => {
									cursorCircle.style.transform = "scale(1)";
									cursorCircle.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
								});
							});
						document.querySelectorAll(".card-item").forEach((card) => {
							const readButton = document.createElement("button");
							readButton.className = "btn btn-info mt-2";
							readButton.textContent = "Lire la carte";
							readButton.onclick = () => {
								const title = card.querySelector(".card-title").textContent;
								const subTitle =
									card.querySelector(".card-body h6").textContent;
								const description =
									card.querySelector(".card-text").textContent;
								const utterance = new SpeechSynthesisUtterance(
									`${title}. ${subTitle}. ${description}`
								);
								utterance.lang = "fr-FR";
								window.speechSynthesis.speak(utterance);
							};
							card.querySelector(".card-body").appendChild(readButton);
						});
					})
					.catch((error) => console.error("Error fetching data:", error));
			});

			const cursorCircle = document.createElement("div");

			cursorCircle.style.zIndex = "9999";
			cursorCircle.style.position = "fixed";
			cursorCircle.style.width = "30px";
			cursorCircle.style.height = "30px";
			cursorCircle.style.borderRadius = "50%";
			cursorCircle.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
			cursorCircle.style.pointerEvents = "none";
			cursorCircle.style.transition = "transform 0.2s ease";
			document.body.appendChild(cursorCircle);
			handleMouseMove = (event) => {
				const xoffset = 15;
				const yoffset = 15;
				const y = event.pageY;
				const x = event.pageX;
				const ref = cursorCircle;
				const scrollLeft =
					window.scrollX !== undefined
						? window.scrollX
						: (
								document.documentElement ||
								document.body.parentNode ||
								document.body
						  ).scrollLeft;
				const scrollTop =
					window.scrollY !== undefined
						? window.scrollY
						: (
								document.documentElement ||
								document.body.parentNode ||
								document.body
						  ).scrollTop;
				ref.style.left = x - scrollLeft - xoffset + "px";
				ref.style.top = y - scrollTop - yoffset + "px";
			};
			document.addEventListener("mousemove", handleMouseMove, false);
		</script>
	</body>
</html>
